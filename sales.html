<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Management - StorePro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <nav class="flex justify-between items-center bg-white/80 backdrop-blur-md rounded-xl p-4 shadow-lg mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full"></div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                    StorePro Sales
                </h1>
            </div>
            <div class="flex space-x-4">
                <a href="#" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 transition duration-300 ease-in-out">
                    Dashboard
                </a>
                <a href="#" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 transition duration-300 ease-in-out">
                    Inventory
                </a>
                <a href="#" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-blue-100 transition duration-300 ease-in-out">
                    New Sale
                </a>
            </div>
        </nav>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                            Sales History
                        </h2>
                        <button id="newSaleBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:opacity-90 transition duration-300">
                            + Create New Sale
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-3 px-4">Sale ID</th>
                                    <th class="py-3 px-4">Product</th>
                                    <th class="py-3 px-4">Quantity</th>
                                    <th class="py-3 px-4">Unit Price</th>
                                    <th class="py-3 px-4">Total Value</th>
                                    <th class="py-3 px-4">Date</th>
                                    <th class="py-3 px-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Sales rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div>
                <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-4">
                        Sales Summary
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Total Sales Today</div>
                            <div class="text-2xl font-bold text-blue-800">₦0</div>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Total Sales This Month</div>
                            <div class="text-2xl font-bold text-green-800">₦0</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Best Selling Product</div>
                            <div class="text-2xl font-bold text-purple-800">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Sale Modal -->
        <div id="newSaleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                    Create New Sale
                </h2>
                <form id="newSaleForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Product</label>
                        <select id="productSelect" class="w-full px-3 py-2 border rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Quantity</label>
                            <input id="quantityInput" type="number" class="w-full px-3 py-2 border rounded-lg" placeholder="0" min="1" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Unit Price</label>
                            <input id="unitPriceInput" type="text" class="w-full px-3 py-2 border rounded-lg" readonly>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Total Value</label>
                        <input id="totalValueInput" type="text" class="w-full px-3 py-2 border rounded-lg" readonly>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelSaleBtn" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg">
                            Complete Sale
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // DOM Elements
        const newSaleBtn = document.getElementById('newSaleBtn');
        const newSaleModal = document.getElementById('newSaleModal');
        const cancelSaleBtn = document.getElementById('cancelSaleBtn');
        const productSelect = document.getElementById('productSelect');
        const quantityInput = document.getElementById('quantityInput');
        const unitPriceInput = document.getElementById('unitPriceInput');
        const totalValueInput = document.getElementById('totalValueInput');
        const newSaleForm = document.getElementById('newSaleForm');
        const salesTableBody = document.getElementById('salesTableBody');

        // Fetch Inventory Products
        async function fetchInventoryProducts() {
            try {
                const response = await fetch('http://127.0.0.1:8000/inventory');
                const data = await response.json();
                
                productSelect.innerHTML = '<option value="">Select Product</option>';
                
                data.inventory.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product;
                    option.setAttribute('data-price', product.unit_price);
                    option.setAttribute('data-inventory', product.in_stock);
                    option.textContent = `${product.product} - ₦${product.unit_price.toLocaleString()} (${product.in_stock} in stock)`;
                    productSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching inventory:', error);
                alert('Failed to load product inventory');
            }
        }

        // Update Sales Summary
        async function updateSalesSummary() {
            try {
                const response = await fetch('http://127.0.0.1:8000/sales-summary');
                const data = await response.json();
                
                // Update today's sales
                const todaySalesElement = document.querySelector('.bg-blue-100 .text-2xl');
                todaySalesElement.textContent = `₦${data.today_sales.total_sales.toLocaleString()}`;
                
                // Update monthly sales
                const monthlySalesElement = document.querySelector('.bg-green-100 .text-2xl');
                monthlySalesElement.textContent = `₦${data.month_sales.total_sales.toLocaleString()}`;
                
                // Update best-selling product
                const bestSellingElement = document.querySelector('.bg-purple-100 .text-2xl');
                if (data.best_selling_product) {
                    bestSellingElement.textContent = data.best_selling_product._id;
                } else {
                    bestSellingElement.textContent = 'No Sales';
                }
            } catch (error) {
                console.error('Error updating sales summary:', error);
            }
        }

       // Modify fetchSalesHistory to use sale_id from backend
       async function fetchSalesHistory() {
            try {
                const response = await fetch('http://127.0.0.1:8000/monthly-revenue');
                const data = await response.json();
                
                salesTableBody.innerHTML = ''; // Clear existing rows
                
                // Populate sales table (adjust based on actual response structure)
                data.forEach(sale => {
                    const newRow = document.createElement('tr');
                    newRow.classList.add('border-b', 'hover:bg-blue-50', 'transition');
                    newRow.innerHTML = `
                        <td class="py-3 px-4">${sale.sale_id || '#SA' + Math.floor(Math.random() * 1000)}</td>
                        <td class="py-3 px-4">${sale.product}</td>
                        <td class="py-3 px-4">${sale.quantity}</td>
                        <td class="py-3 px-4">₦${sale.unit_price.toLocaleString()}</td>
                        <td class="py-3 px-4">₦${sale.total_price.toLocaleString()}</td>
                        <td class="py-3 px-4">${new Date(sale.date).toLocaleDateString()}</td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-2">
                                <button class="text-blue-500 hover:text-blue-700">
                                    <i data-feather="eye" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    salesTableBody.prepend(newRow);
                });
                
                feather.replace();
            } catch (error) {
                console.error('Error fetching sales history:', error);
            }
        }

        // Product Selection Event Listener
        productSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            const price = selectedOption.getAttribute('data-price');
            const inventory = selectedOption.getAttribute('data-inventory');
            
            unitPriceInput.value = `₦${parseFloat(price).toLocaleString()}`;
            quantityInput.max = inventory;
            quantityInput.value = ''; // Reset quantity
            totalValueInput.value = ''; // Reset total value
        });

        // Quantity Input Event Listener
        quantityInput.addEventListener('input', () => {
            if (!productSelect.value) return;
            
            const price = parseFloat(productSelect.selectedOptions[0].getAttribute('data-price'));
            const quantity = parseInt(quantityInput.value);
            
            if (quantity > 0) {
                const totalValue = price * quantity;
                totalValueInput.value = `₦${totalValue.toLocaleString()}`;
            } else {
                totalValueInput.value = '';
            }
        });

         // Function to generate unique sale ID
         function generateSaleId() {
            const prefix = 'SA';
            const randomNumber = Math.floor(1000 + Math.random() * 9000); // 4-digit number
            return `#${prefix}${randomNumber}`;
        }

        // Function to convert to Decimal (handles floating-point precision)
        function toDecimal(value) {
            return parseFloat(value.toFixed(2));
        }

        // Form Submission Event Listener
        newSaleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const product = productSelect.value;
            const quantity = parseInt(quantityInput.value);
            const unitPrice = toDecimal(parseFloat(productSelect.selectedOptions[0].getAttribute('data-price')));
            const totalValue = toDecimal(unitPrice * quantity);
            
            
            // Generate unique sale ID
            const saleId = generateSaleId();
            
            try {
                const response = await fetch('http://127.0.0.1:8000/create-sale', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sale_id: saleId,  // Include sale ID
                        product: product,
                        quantity: quantity,
                        unit_price: unitPrice,
                        total_value: totalValue,
                        date: new Date().toISOString()  // Send date in ISO format
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Sale creation failed');
                }

                // Close modal and reset form
                newSaleModal.classList.add('hidden');
                newSaleForm.reset();

                // Refresh various components
                await Promise.all([
                    fetchInventoryProducts(),
                    updateSalesSummary(),
                    fetchSalesHistory()
                ]);

                alert(`Sale completed successfully! Sale ID: ${saleId}`);
            } catch (error) {
                console.error('Error creating sale:', error);
                alert(error.message);
            }
        });

         // Update quantity calculation to use toDecimal
         quantityInput.addEventListener('input', () => {
            if (!productSelect.value) return;
            
            const price = toDecimal(parseFloat(productSelect.selectedOptions[0].getAttribute('data-price')));
            const quantity = parseInt(quantityInput.value);
            
            if (quantity > 0) {
                const totalValue = toDecimal(price * quantity);
                totalValueInput.value = `₦${totalValue.toLocaleString()}`;
            } else {
                totalValueInput.value = '';
            }
        });

        // Modal Toggle Events
        newSaleBtn.addEventListener('click', () => {
            newSaleModal.classList.remove('hidden');
        });

        cancelSaleBtn.addEventListener('click', () => {
            newSaleModal.classList.add('hidden');
            newSaleForm.reset();
        });

        // Initial Page Load
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                fetchInventoryProducts(),
                updateSalesSummary(),
                fetchSalesHistory()
            ]);
        });
    </script>
</body>
</html>